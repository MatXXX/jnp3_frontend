var apiUrl="http://jnp3-dev.eu-central-1.elasticbeanstalk.com/api/",wsUrl="ws://ec2-54-93-49-189.eu-central-1.compute.amazonaws.com:8080/ws";angular.module("JNPAPP.api",["ngResource"]).config(["$resourceProvider",function(a){a.defaults.stripTrailingSlashes=!1}]).factory("User",["$resource",function(a){return a(apiUrl+"users/:username/",{},{save:{method:"POST",url:apiUrl+"users/create/"}},{stripTrailingSlashes:!1})}]).factory("Post",["$resource",function(a){return a(apiUrl+"posts/:id/",{id:"@id"})}]).factory("UserPosts",["$resource",function(a){return a(apiUrl+"users/:username/posts/")}]).factory("UserFriends",["$resource",function(a){return a(apiUrl+"users/:username/friends/")}]).config(["$httpProvider",function(a){a.defaults.headers.common["X-CSRFToken"]="{{ csrf_token|escapejs }}"}]),angular.module("JNPAPP",["ngCookies","ui.router","JNPAPP.api","angular-websocket"]).config(["$httpProvider","$stateProvider","$urlRouterProvider",function(a,b,c){a.defaults.xsrfCookieName="csrftoken",a.defaults.xsrfHeaderName="X-CSRFToken",a.interceptors.push("authInterceptor"),b.state("wall",{url:"/",templateUrl:"pages/wall.html",controller:"WallPostsController"}).state("userDetails",{url:"/user/:username",templateUrl:"pages/userDetail.html",controller:"UserDetailController"}).state("userDetails.posts",{url:"/posts",views:{content:{templateUrl:"pages/postList.html",controller:"UserPostsController"}}}).state("userDetails.friends",{url:"/friends",views:{content:{templateUrl:"pages/friendList.html",controller:"UserFriendsController"}}}).state("searchResult",{url:"/search/:query",templateUrl:"pages/searchResult.html",controller:"SearchResultController"}),c.otherwise("/")}]).run(["$http","$cookies",function(a,b){var c=b.get("Authorization");null==c&&(window.location="/login.html"),a.defaults.headers.common.Authorization=c}]).directive("execOnScrollToBottom",function(){return{restrict:"A",link:function(a,b,c){var d=a.$eval(c.execOnScrollToBottom),e=b[0].clientHeight;b.on("scroll",function(b){var c=b.target;c.scrollHeight-c.scrollTop===e&&(console.log("bottom hit"),a.$apply(d))})}}}),angular.module("JNPAPP").controller("CurrentUserController",["$scope","$rootScope","CurrentUserService","UserFriends",function(a,b,c,d){a.currentUser=c.getUser(),a.currentUser.$promise.then(function(c){a.username=c.username,b.username=c.username}),a.friends=c.getFriends(),a.newFriend=new d,a.newFriendError=null,a.addFriend=function(){c.addFriend(a.newFriend,function(b){a.friends.push(b),a.newFriend=new d,a.newFriendError=null},function(b){a.newFriendError=b.data})},a.logout=function(){a.user=void 0,c.logout()}}]).controller("WallPostsController",["$scope","WallService","Post",function(a,b,c){a.posts=[],a.newPost=new c,a.newPostError=null,a.pageNumber=1;var d=function(b){Array.prototype.push.apply(a.posts,b),a.pageNumber++},e=function(b){404==b.status?a.pageNumber=0:a.postsLoadError=b.data},f=function(b){a.newPost=new c,a.newPostError=null,a.posts.unshift(b)},g=function(b){a.newPostError=b.data};a.getPosts=function(){b.getPosts(a.pageNumber,d,e)},a.Post=function(){b.addPost(a.newPost,f,g)},a.getPosts(),a.handleScrollToBottom=function(){a.getPosts()}}]).controller("UserDetailController",["$scope","$stateParams","UserService",function(a,b,c){a.username=b.username}]).controller("UserPostsController",["$scope","$stateParams","UserService",function(a,b,c){a.posts=c.getPosts(b.username)}]).controller("UserFriendsController",["$scope","$stateParams","UserService",function(a,b,c){a.friends=c.getFriends(b.username)}]).controller("ElasticSearchController",["$scope","$state",function(a,b){a.elasticSearchQuery="",a.search=function(){b.go("searchResult",{query:a.elasticSearchQuery},{reload:!0})}}]).controller("SearchResultController",["$scope","$stateParams","ElasticSearchService",function(a,b,c){c.search(b.query,function(b){a.posts=b},function(a){alert(a)})}]).controller("ChatController",["$scope","ChatFactory",function(a,b){a.chatUser=null,a.newChatMessage=null,a.messages="",a.chat=b,a.send=function(){b.send(a.chatUser,a.newChatMessage),a.newChatMessage=""}}]),angular.module("JNPAPP").service("authInterceptor",["$q",function(a){this.responseError=function(b){return 401==b.status?window.location="/login.html":500==b.status&&alert("SERVER ERROR"),a.reject(b)}}]).service("UserService",["User","UserPosts","UserFriends",function(a,b,c){this.getUser=function(b){return a.get({username:b})},this.getPosts=function(a){return b.query({username:a})},this.getFriends=function(a){return this.friends=c.query({username:a}),this.friends}}]).service("CurrentUserService",["$cookies","User","UserPosts","UserFriends","Post",function(a,b,c,d,e){var f=b.get({username:"current"});this.getUser=function(){return f},this.getPosts=function(){return c.query({username:"current"})},this.getFriends=function(){return d.query({username:"current"})},this.addFriend=function(a,b,c){a.$save({username:"current"}).then(function(a){b(a)}).then(function(){},function(a){c(a)})},this.logout=function(){a.remove("Authorization"),window.location="/login.html"}}]).service("WallService",["$http","Post",function(a,b){return this.getPosts=function(b,c,d){0!=b&&a({method:"GET",url:apiUrl+"wallPosts/",params:{page:b}}).then(function(a){c(a.data.results)}).then(function(){},function(a){d(a)})},this.addPost=function(a,b,c){a.$save().then(function(a){b(a)}).then(function(){},function(a){c(a)})},this}]).service("ElasticSearchService",["$http","Post",function(a,b){this.search=function(b,c,d){a.post(apiUrl+"posts/search/",{text:b}).then(function(a){c(a.data)},function(a){alert(a.error)})}}]).factory("ChatFactory",["$websocket","$rootScope","$cookies","CurrentUserService",function(a,b,c,d){var e,f=[],g=(d.getUser().$promise.then(function(b){var c=a(wsUrl+"?"+b.username);c.onMessage(function(a){var b=JSON.parse(a.data);f.push(b)}),e=function(a){c.send(a)}}),function(a,b){if(null!=b&&""!=b&&null!=a&&""!=a){f.push({sender:"You",msg:b});var d=c.get("Authorization");d=d.substring(6),e({receiver:a,token:d,msg:b})}});return{messages:f,send:g}}]);